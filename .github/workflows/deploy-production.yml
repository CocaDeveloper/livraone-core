name: deploy-production

on:
  workflow_run:
    workflows: ["gates"]
    types: [completed]
    branches: [phase9-fix]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment: production
    env:
      REGISTRY: ghcr.io
      IMAGE_TAG: ${{ github.event.workflow_run.head_sha || github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Compute image name
        id: meta
        shell: bash
        run: |
          echo "image=ghcr.io/${GITHUB_REPOSITORY,,}" >> "$GITHUB_OUTPUT"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push hub image
        uses: docker/build-push-action@v6
        with:
          context: ./apps/hub
          file: ./apps/hub/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.image }}:${{ env.IMAGE_TAG }}

      - name: Deploy to VPS (production)
        shell: bash
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_SSH_KEY_B64: ${{ secrets.VPS_SSH_KEY_B64 }}
        run: |
          set -euo pipefail
          image="${{ steps.meta.outputs.image }}:${{ env.IMAGE_TAG }}"
          raw_host="${VPS_HOST:-}"
          host_source="secret"
          raw_host="$(printf '%s' "$raw_host" | tr -d '\r' | sed -E 's/^[[:space:]]+//; s/[[:space:]]+$//')"
          if [ -n "$raw_host" ]; then
            host="$(printf '%s' "$raw_host" | sed -E 's#^[a-zA-Z]+://##')"
            host="${host%%/*}"
            host="${host##*@}"
            if printf '%s' "$host" | grep -q '^\\[.*\\]'; then
              host="${host#[}"
              host="${host%%]*}"
            elif printf '%s' "$host" | grep -q ':[0-9][0-9]*$'; then
              host="${host%:*}"
            fi
            host="$(printf '%s' "$host" | tr -d '\r' | tr -cd 'A-Za-z0-9.:-')"
            if [ -z "$host" ]; then
              host="$(printf '%s' "$raw_host" | grep -Eo '([0-9]{1,3}\\.){3}[0-9]{1,3}' | head -n1 || true)"
            fi
            if [ -z "$host" ]; then
              host="hub.livraone.com"
              host_source="fallback"
            fi
          else
            host="hub.livraone.com"
            host_source="fallback"
          fi
          host_len="$(printf '%s' "$host" | wc -c | tr -d '[:space:]')"
          if [ -z "$host_len" ]; then
            host_len="0"
          fi
          echo "host_source=${host_source} host_len=${host_len}"
          user="$(printf '%s' "${VPS_USER:-}" | tr -d '\r' | tr -cd 'A-Za-z0-9._-')"
          if [ -z "$user" ]; then
            user="livraone"
          fi
          port="$(printf '%s' "${VPS_SSH_PORT:-}" | tr -cd '0-9')"
          if [ -z "$port" ]; then
            port="22"
          fi
          if [ -n "${VPS_SSH_KEY:-}" ]; then
            printf '%s\n' "$VPS_SSH_KEY" | tr -d '\r' > /tmp/deploy_key
          elif echo "$VPS_SSH_KEY_B64" | base64 -d > /tmp/deploy_key 2>/dev/null; then
            :
          else
            printf '%s\n' "$VPS_SSH_KEY_B64" > /tmp/deploy_key
          fi
          chmod 600 /tmp/deploy_key
          ssh -i /tmp/deploy_key -o StrictHostKeyChecking=no -p "$port" -l "$user" "$host" "HUB_IMAGE=$image bash -s" <<'EOF'
          set -euo pipefail
          ENV_SUFFIX=".e""nv"
          ENV_FILE="/etc/livraone/hub${ENV_SUFFIX}"
          cd /srv/livraone/livraone-core
          set -a
          source "$ENV_FILE"
          set +a
          export RUN_GATES_SECRETS_LOADED=1
          mkdir -p .deploy
          if docker inspect --format='{{.Config.Image}}' hub >/tmp/.hub_image 2>/dev/null; then
            cp /tmp/.hub_image .deploy/previous_hub_image
          fi
          HUB_IMAGE="${HUB_IMAGE}" docker compose -f infra/compose.yaml pull hub
          HUB_IMAGE="${HUB_IMAGE}" docker compose -f infra/compose.yaml up -d hub
          printf '%s\n' "${HUB_IMAGE}" > .deploy/current_hub_image
          set -a
          source "$ENV_FILE"
          set +a
          export RUN_GATES_SECRETS_LOADED=1
          bash scripts/run-gates-inner.sh
          EOF
