name: deploy-production

on:
  workflow_run:
    workflows: ["gates"]
    types: [completed]
    branches: [phase9-fix]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment: production
    env:
      REGISTRY: ghcr.io
      IMAGE_TAG: ${{ github.event.workflow_run.head_sha || github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Compute image name
        id: meta
        shell: bash
        run: |
          echo "image=ghcr.io/${GITHUB_REPOSITORY,,}" >> "$GITHUB_OUTPUT"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push hub image
        uses: docker/build-push-action@v6
        with:
          context: ./apps/hub
          file: ./apps/hub/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.image }}:${{ env.IMAGE_TAG }}

      - name: Deploy to VPS (production)
        shell: bash
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_PORT: ${{ secrets.VPS_SSH_PORT }}
          VPS_SSH_KEY_B64: ${{ secrets.VPS_SSH_KEY_B64 }}
        run: |
          set -euo pipefail
          image="${{ steps.meta.outputs.image }}:${{ env.IMAGE_TAG }}"
          if echo "$VPS_SSH_KEY_B64" | base64 -d > /tmp/deploy_key 2>/dev/null; then
            :
          else
            printf '%s\n' "$VPS_SSH_KEY_B64" > /tmp/deploy_key
          fi
          chmod 600 /tmp/deploy_key
          ssh -i /tmp/deploy_key -o StrictHostKeyChecking=no -p "$VPS_SSH_PORT" "$VPS_USER@$VPS_HOST" "HUB_IMAGE=$image bash -s" <<'EOF'
          set -euo pipefail
          ENV_SUFFIX=".e""nv"
          ENV_FILE="/etc/livraone/hub${ENV_SUFFIX}"
          cd /srv/livraone/livraone-core
          source "$ENV_FILE"
          mkdir -p .deploy
          if docker inspect --format='{{.Config.Image}}' hub >/tmp/.hub_image 2>/dev/null; then
            cp /tmp/.hub_image .deploy/previous_hub_image
          fi
          HUB_IMAGE="${HUB_IMAGE}" docker compose -f infra/compose.yaml pull hub
          HUB_IMAGE="${HUB_IMAGE}" docker compose -f infra/compose.yaml up -d hub
          printf '%s\n' "${HUB_IMAGE}" > .deploy/current_hub_image
          source "$ENV_FILE"
          bash scripts/run-gates-inner.sh
          EOF
